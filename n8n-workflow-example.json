{
  "name": "QuoteMaster Pro - Envio de Cota√ß√µes (v2)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "quote-sender",
        "responseMode": "responseNode"
      },
      "id": "webhook-start",
      "name": "Webhook Cota√ß√µes",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "functionCode": "// Este n√≥ clona o item de entrada para garantir estrutura consistente\nreturn items;"
      },
      "id": "normalize",
      "name": "Normalizar Entrada",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [420, 300]
    },
    {
      "parameters": {
        "functionCode": "// Expande os fornecedores para m√∫ltiplos itens para processamento paralelo\n// Entrada esperada do Webhook: { quote, client, suppliers: [...], settings, template_data }\nconst inItem = items[0].json;\n\nif (!inItem.suppliers || !Array.isArray(inItem.suppliers) || inItem.suppliers.length === 0) {\n  return items;\n}\n\nconst out = inItem.suppliers.map((supplier) => ({\n  json: {\n    supplier,\n    quote: inItem.quote,\n    client: inItem.client,\n    settings: inItem.settings || {},\n    template_data: inItem.template_data || null\n  }\n}));\n\nreturn out;"
      },
      "id": "expand-suppliers",
      "name": "Expandir Fornecedores",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [640, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.settings.send_email }}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-email",
      "name": "Enviar E-mail?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [860, 180]
    },
    {
      "parameters": {
        "functionCode": "const { quote, client, supplier, settings } = $json;\n\nconst money = (v) => { try { return (new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' })).format(Number(v||0)); } catch { return `R$ ${(Number(v||0)).toFixed(2)}`; } };\nconst dateBr = (d) => { return d ? new Date(d).toLocaleString('pt-BR') : 'A definir'; };\n\nconst html = `\n<div style=\"font-family: Arial, sans-serif; max-width: 640px; margin: 0 auto;\">\n  <h2 style=\"color:#003366;\">üè¢ Nova Cota√ß√£o Dispon√≠vel</h2>\n  <div style=\"background:#f6f8fa; padding:16px; border-radius:8px; margin:12px 0;\">\n    <p><strong>üìã Cota√ß√£o:</strong> ${quote.title}</p>\n    <p><strong>üÜî ID:</strong> ${quote.id}</p>\n    <p><strong>üí∞ Total Estimado:</strong> ${money(quote.total)}</p>\n    <p><strong>üìÖ Prazo:</strong> ${dateBr(quote.deadline)}</p>\n    <p><strong>üë§ Cliente:</strong> ${client.name}</p>\n    <p><strong>üìß E-mail:</strong> ${client.email || '‚Äî'}</p>\n    ${client.phone ? `<p><strong>üì± Telefone:</strong> ${client.phone}</p>` : ''}\n  </div>\n  <h3 style=\"color:#003366;\">üì¶ Itens (${(quote.items||[]).length})</h3>\n  <table style=\"width:100%; border-collapse: collapse;\">\n    <thead>\n      <tr style=\"background:#003366; color:#fff;\">\n        <th style=\"padding:8px; border:1px solid #ddd; text-align:left;\">Produto</th>\n        <th style=\"padding:8px; border:1px solid #ddd; text-align:center;\">Qtd</th>\n        <th style=\"padding:8px; border:1px solid #ddd; text-align:right;\">Unit.</th>\n        <th style=\"padding:8px; border:1px solid #ddd; text-align:right;\">Total</th>\n      </tr>\n    </thead>\n    <tbody>\n      ${(quote.items||[]).map(i => `\n        <tr>\n          <td style=\"padding:8px; border:1px solid #ddd;\">${i.product_name}</td>\n          <td style=\"padding:8px; border:1px solid #ddd; text-align:center;\">${i.quantity}</td>\n          <td style=\"padding:8px; border:1px solid #ddd; text-align:right;\">${money(i.unit_price)}</td>\n          <td style=\"padding:8px; border:1px solid #ddd; text-align:right;\"><strong>${money(i.total)}</strong></td>\n        </tr>`).join('')}\n    </tbody>\n  </table>\n  ${settings.custom_message ? `<div style=\"background:#e8f4f8; padding:12px; border-radius:6px; margin:16px 0;\"><strong>üí¨ Mensagem:</strong><br/>${settings.custom_message}</div>` : ''}\n  <div style=\"color:#6b7280; font-size:12px; text-align:center; margin-top:16px;\"><em>Enviado automaticamente via QuoteMaster Pro</em></div>\n</div>`;\n\nreturn { to: supplier.email, subject: `üìã Nova Cota√ß√£o: ${quote.title} (ID: ${quote.id})`, html };"
      },
      "id": "prepare-email",
      "name": "Preparar E-mail",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1100, 180]
    },
    {
      "parameters": {
        "fromEmail": "noreply@quotemaster.pro",
        "toEmail": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "emailFormat": "html",
        "html": "={{ $json.html }}"
      },
      "id": "send-email",
      "name": "Enviar E-mail",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [1340, 180]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.settings.send_whatsapp }}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-whatsapp",
      "name": "Enviar WhatsApp?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [860, 420]
    },
    {
      "parameters": {
        "functionCode": "// Log para debug\nconsole.log('Dados recebidos:', JSON.stringify($json, null, 2));\n\nconst { quote, client, supplier, settings } = $json;\n\n// Verifica√ß√£o de seguran√ßa\nif (!quote || !client || !supplier) {\n  console.error('Dados obrigat√≥rios faltando:', { quote: !!quote, client: !!client, supplier: !!supplier });\n  return { error: 'Dados obrigat√≥rios faltando' };\n}\n\nconst money = (v) => {\n  try {\n    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(Number(v || 0));\n  } catch {\n    return `R$ ${(Number(v || 0)).toFixed(2)}`;\n  }\n};\n\nconst dateBr = (d) => {\n  return d ? new Date(d).toLocaleString('pt-BR') : 'A definir';\n};\n\n// Verificar se items existe e √© array\nconst items = Array.isArray(quote.items) ? quote.items : [];\nconsole.log('Items processados:', items.length);\n\nconst itens = items.map(i => {\n  const productName = i.product_name || i.name || 'Produto n√£o especificado';\n  const quantity = i.quantity || 0;\n  const total = i.total || (i.unit_price * quantity) || 0;\n  return `‚Ä¢ ${productName} - Qtd: ${quantity} - Valor: ${money(total)}`;\n}).join('\\n');\n\n// Se n√£o tem itens, usar mensagem padr√£o\nconst itemsText = items.length > 0 ? `üì¶ *Itens:*\\n${itens}\\n` : 'üì¶ *Itens:* Consulte detalhes na cota√ß√£o\\n';\n\nconst baseMessage = `üîî *Nova Cota√ß√£o Dispon√≠vel*\\n\\nüëã Ol√°, ${supplier.name}!\\n\\nüìã *${quote.title || 'Cota√ß√£o'}*\\n${quote.description ? quote.description + '\\n' : ''}\\nüí∞ *Total Estimado:* ${money(quote.total || 0)}\\nüìÖ *Prazo:* ${dateBr(quote.deadline)}\\n\\n${itemsText}`;\n\nconst customMessage = settings?.custom_message;\nlet finalMessage;\n\nif (customMessage) {\n  // Se tem template customizado, usar ele\n  finalMessage = customMessage\n    .replace(/{{quote\\.title}}/g, quote.title || 'Cota√ß√£o')\n    .replace(/{{quote\\.total}}/g, money(quote.total || 0))\n    .replace(/{{quote\\.deadline}}/g, dateBr(quote.deadline))\n    .replace(/{{client\\.name}}/g, client.name || 'Cliente')\n    .replace(/{{supplier\\.name}}/g, supplier.name || 'Fornecedor')\n    .replace(/{{items_list}}/g, items.length > 0 ? itens : 'Consulte detalhes na cota√ß√£o');\n} else {\n  finalMessage = baseMessage;\n}\n\n// Adicionar informa√ß√µes do cliente\nfinalMessage += `\\nüë§ *Cliente:* ${client.name || 'N√£o informado'}`;\nfinalMessage += `\\nüìß *E-mail:* ${client.email || '‚Äî'}`;\nif (client.phone) {\n  finalMessage += `\\nüì± *Telefone:* ${client.phone}`;\n}\nfinalMessage += '\\n\\n‚Äî\\n_Cota√ß√£o enviada via QuoteMaster Pro_';\n\nconsole.log('Mensagem final preparada:', finalMessage.substring(0, 200) + '...');\n\nreturn {\n  phone: supplier.whatsapp || supplier.phone,\n  text: finalMessage,\n  evolution: settings?.evolution || null\n};"
      },
      "id": "prepare-whatsapp",
      "name": "Preparar WhatsApp",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1100, 420]
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "={{ $json.evolution && $json.evolution.api_url && $json.evolution.instance ? $json.evolution.api_url + '/message/sendText/' + $json.evolution.instance : 'https://example.invalid/send' }}",
        "jsonParameters": true,
        "options": {
          "headers": {
            "apikey": "={{ $json.evolution && $json.evolution.token ? $json.evolution.token : '' }}",
            "Content-Type": "application/json"
          }
        },
        "sendBody": true,
        "bodyParametersJson": "={ \n  \"number\": $json.phone,\n  \"text\": $json.text\n}"
      },
      "id": "send-whatsapp",
      "name": "Enviar WhatsApp (Evolution)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1340, 420]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \n  \"success\": true, \n  \"message\": \"Cota√ß√µes processadas\", \n  \"processed_suppliers\": {{ $items().length }},\n  \"timestamp\": \"{{ new Date().toISOString() }}\" \n}"
      },
      "id": "respond",
      "name": "Responder",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1580, 300]
    }
  ],
  "connections": {
    "Webhook Cota√ß√µes": {
      "main": [
        [
          {
            "node": "Normalizar Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Entrada": {
      "main": [
        [
          {
            "node": "Expandir Fornecedores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Expandir Fornecedores": {
      "main": [
        [
          {
            "node": "Enviar E-mail?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Enviar WhatsApp?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Responder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar E-mail?": {
      "main": [
        [
          {
            "node": "Preparar E-mail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar E-mail": {
      "main": [
        [
          {
            "node": "Enviar E-mail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar WhatsApp?": {
      "main": [
        [
          {
            "node": "Preparar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar WhatsApp": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp (Evolution)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    { "id": "qmp", "name": "QuoteMaster Pro" }
  ],
  "triggerCount": 1,
  "versionId": "2"
}
